name: "Fortify Security Check"
description: "Scan source code in repository with self-hosted Fortify SAST"
inputs:
  fortify-ssc-url:
    description: "Fortify SSC URL"
    required: true
  fortify-sc-sast-url:
    description: "Fortify SC SAST URL"
    required: true
  ssc-token:
    description: "Fortify SSC token"
    required: true
  application:
    description: "Application name in Fortify SSC"
    required: true
  application-version:
    description: "Application version in Fortify SSC"
    required: true
  sast-version:
    description: "Fortify SSC SAST module version"
    required: false
    default: "25.2"
  github-token:
    description: "GitHub token"
    required: false
  exit-with-error-on-severity:
    description: "Fail the GitHub Workflow if issues with the specified and above severity are detected during the scan"
    required: false
    default: "Medium"
  enable-report-comment:
    description: "Add comment with summary to pull request conversation"
    required: false
    default: "true"

runs:
  using: "composite"
  steps:
    - name: Configure proxy bypass
      shell: bash
      run: |
        echo "NO_PROXY=.ipakyulibank.uz,.0,.1,.2,.3,.4,.5,.6,.7,.8,.9,.10,.11,.12,.13,.14,.15,.16,.17,.18,.19,.20,.21,.22,.23,.24,.25,.26,.27,.28,.29,.30,.31,.32,.33,.34,.35,.36,.37,.38,.39,.40,.41,.42,.43,.44,.45,.46,.47,.48,.49,.50,.51,.52,.53,.54,.55,.56,.57,.58,.59,.60,.61,.62,.63,.64,.65,.66,.67,.68,.69,.70,.71,.72,.73,.74,.75,.76,.77,.78,.79,.80,.81,.82,.83,.84,.85,.86,.87,.88,.89,.90,.91,.92,.93,.94,.95,.96,.97,.98,.99,.100,.101,.102,.103,.104,.105,.106,.107,.108,.109,.110,.111,.112,.113,.114,.115,.116,.117,.118,.119,.120,.121,.122,.123,.124,.125,.126,.127,.128,.129,.130,.131,.132,.133,.134,.135,.136,.137,.138,.139,.140,.141,.142,.143,.144,.145,.146,.147,.148,.149,.150,.151,.152,.153,.154,.155,.156,.157,.158,.159,.160,.161,.162,.163,.164,.165,.166,.167,.168,.169,.170,.171,.172,.173,.174,.175,.176,.177,.178,.179,.180,.181,.182,.183,.184,.185,.186,.187,.188,.189,.190,.191,.192,.193,.194,.195,.196,.197,.198,.199,.200,.201,.202,.203,.204,.205,.206,.207,.208,.209,.210,.211,.212,.213,.214,.215,.216,.217,.218,.219,.220,.221,.222,.223,.224,.225,.226,.227,.228,.229,.230,.231,.232,.233,.234,.235,.236,.237,.238,.239,.240,.241,.242,.243,.244,.245,.246,.247,.248,.249,.250,.251,.252,.253,.254,.255" >> $GITHUB_ENV
        echo "no_proxy=.ipakyulibank.uz,.0,.1,.2,.3,.4,.5,.6,.7,.8,.9,.10,.11,.12,.13,.14,.15,.16,.17,.18,.19,.20,.21,.22,.23,.24,.25,.26,.27,.28,.29,.30,.31,.32,.33,.34,.35,.36,.37,.38,.39,.40,.41,.42,.43,.44,.45,.46,.47,.48,.49,.50,.51,.52,.53,.54,.55,.56,.57,.58,.59,.60,.61,.62,.63,.64,.65,.66,.67,.68,.69,.70,.71,.72,.73,.74,.75,.76,.77,.78,.79,.80,.81,.82,.83,.84,.85,.86,.87,.88,.89,.90,.91,.92,.93,.94,.95,.96,.97,.98,.99,.100,.101,.102,.103,.104,.105,.106,.107,.108,.109,.110,.111,.112,.113,.114,.115,.116,.117,.118,.119,.120,.121,.122,.123,.124,.125,.126,.127,.128,.129,.130,.131,.132,.133,.134,.135,.136,.137,.138,.139,.140,.141,.142,.143,.144,.145,.146,.147,.148,.149,.150,.151,.152,.153,.154,.155,.156,.157,.158,.159,.160,.161,.162,.163,.164,.165,.166,.167,.168,.169,.170,.171,.172,.173,.174,.175,.176,.177,.178,.179,.180,.181,.182,.183,.184,.185,.186,.187,.188,.189,.190,.191,.192,.193,.194,.195,.196,.197,.198,.199,.200,.201,.202,.203,.204,.205,.206,.207,.208,.209,.210,.211,.212,.213,.214,.215,.216,.217,.218,.219,.220,.221,.222,.223,.224,.225,.226,.227,.228,.229,.230,.231,.232,.233,.234,.235,.236,.237,.238,.239,.240,.241,.242,.243,.244,.245,.246,.247,.248,.249,.250,.251,.252,.253,.254,.255" >> $GITHUB_ENV

    - name: Login to Fortify SSC
      shell: bash
      run: |
        fcli ssc session login \
          --url ${{ inputs.fortify-ssc-url }} \
          --sc-sast-url ${{ inputs.fortify-sc-sast-url }} \
          -t ${{ inputs.ssc-token }} \
          --insecure \
          -c clienttoken

    - name: Ensure application version exists
      shell: bash
      run: |
        fcli ssc appversion create \
          "${{ inputs.application }}:${{ inputs.application-version }}" \
          --issue-template "Prioritized High Risk Issue Template" \
          --copy-from "${{ inputs.application }}:master" \
          --auto-required-attrs \
          --skip-if-exists

    - name: Create package with source code
      shell: bash
      run: |
        scancentral package -o package.zip

    - name: Start scan session
      shell: bash
      run: |
        fcli sc-sast scan start \
          --publish-to ${{ inputs.application }}:${{ inputs.application-version }} \
          -f package.zip \
          -v ${{ inputs.sast-version }} \
          --store sc_sast_scan

    - name: Waiting for the scan to complete
      shell: bash
      run: |
        fcli sc-sast scan wait-for ::sc_sast_scan::

    - name: Downloading the scan report
      shell: bash
      run: |
        fcli ssc action run github-sast-report \
          --appversion ${{ inputs.application }}:${{ inputs.application-version }}

    - name: Create pull request comment
      if: ${{ github.event_name == 'pull_request' && inputs.enable-report-comment == 'true' }}
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const { execSync } = require('child_process');

          const issue_number = context.issue.number;
          const owner = context.repo.owner;
          const repo = context.repo.repo;
          const sha = context.sha

          function cleanPath(fullFileName) {
              return fullFileName.replace(/^Src\//, '');
          }

          function issueKey(issue) {
              return `${issue.fullFileName}:${issue.lineNumber}:${issue.issueName}`;
          }

          function issueDescription(issue) {
              const file = cleanPath(issue.fullFileName);
              const line = issue.lineNumber == null ? '' : ':' + issue.lineNumber

              return `* ${issue.scanStatus} (${issue.engineCategory}) - ${issue.issueName}:
              [${file}${line}](https://github.com/${owner}/${repo}/blob/${sha}/${file}#L${issue.lineNumber == null ? '' : issue.lineNumber})`
          }

          const output = execSync(
            'fcli ssc issue list --av ${{ inputs.application }}:${{ inputs.application-version }} --include visible,removed -o json',
            { maxBuffer: 50 * 1024 * 1024 }
          );
          const parsedOutput = JSON.parse(output).filter(item => !item.suppressed);

          const newIssues = parsedOutput.filter(issue => issue.scanStatus === 'NEW' || issue.scanStatus === 'REINTRODUCED');
          const removedIssues = parsedOutput.filter(issue => issue.scanStatus === 'REMOVED');

          // Убираем дубликаты: если issue есть и в NEW и в REMOVED — это изменение, не показываем в REMOVED
          const newKeys = new Set(newIssues.map(issueKey));
          const filteredRemovedIssues = removedIssues.filter(issue => !newKeys.has(issueKey(issue)));

          const newIssuesText = newIssues.length > 0
            ? newIssues.map(issueDescription).join("\n")
            : '* No new or re-introduced issues were detected';

          const removedIssuesText = filteredRemovedIssues.length > 0
            ? filteredRemovedIssues.map(issueDescription).join("\n")
            : '* No removed issues were detected';

          const body = `## Fortify vulnerability summary
          Any issues listed below are based on comparing the latest scan results against the previous scan results for SSC application version **${{ inputs.application }}:${{ inputs.application-version }}**.

          To avoid interference from scans for other PR's or branches, it is recommended to track each PR/branch in a separate SSC application version.

          ### New Issues
          ${newIssuesText}

          ### Removed Issues
          ${removedIssuesText}`;

          await github.rest.issues.createComment({
            issue_number,
            owner,
            repo,
            body
          })

    - name: Generate vulnerability report
      shell: bash
      run: |
        report_file=$(mktemp)

        fcli ssc issue list \
          --av ${{ inputs.application }}:${{ inputs.application-version }} \
          -o json | jq '[.[] | select(.suppress != true)]' > "$report_file"

        issues_count=$(jq 'length' "$report_file")

        if [ "$issues_count" -gt 0 ]; then
          echo "Found $issues_count items"

          echo "## Issues found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Total number: **$issues_count**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Priority | Issue Name | File | Line Number |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------------|------|-------------|" >> $GITHUB_STEP_SUMMARY

          jq -r '
            sort_by(
              [
                (if .friority == "Critical" then 1
                 elif .friority == "High" then 2
                 elif .friority == "Medium" then 3
                 elif .friority == "Low" then 4
                 else 5 end),
                .impact
              ]
            ) |
            .[] |
            "| \(.friority) | \(.issueName) | \(.fullFileName | sub("^Src/";"")) | \(.lineNumber) |"
          ' "$report_file" >> $GITHUB_STEP_SUMMARY

          severity_rank() {
            case $1 in
              Critical) echo 4 ;;
              High) echo 3 ;;
              Medium) echo 2 ;;
              Low) echo 1 ;;
              *) echo 0 ;;
            esac
          }
          error_on_severity_rank=$(severity_rank "${{ inputs.exit-with-error-on-severity }}")

          selected_priority_issues_count=$(jq --argjson rank "$error_on_severity_rank" '
            map(select(
              (.friority == "Critical" and 4 >= $rank) or
              (.friority == "High" and 3 >= $rank) or
              (.friority == "Medium" and 2 >= $rank) or
              (.friority == "Low" and 1 >= $rank)
            )) | length
          ' "$report_file")
          rm "$report_file"

          if [ "$selected_priority_issues_count" -gt 0 ]; then
            exit 1
          fi
        else
          echo "No items with selected and above severity found."
          rm "$report_file"
        fi

    - name: Logout from Fortify SSC
      shell: bash
      if: always()
      run: |
        fcli ssc session logout

    - name: Upload scan report as workflow artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: sarif-files
        path: ./gh-fortify-sast.sarif
